# OpenProject + Gitea 통합 프로젝트 관리 시스템
# Docker Compose 설정 파일

# ============================================
# 네트워크 설정
# ============================================
networks:
  maxops-network:
    driver: bridge

# ============================================
# 서비스 정의
# ============================================
services:

  # ------------------------------------------
  # PostgreSQL 데이터베이스
  # ------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: maxops-postgres
    restart: unless-stopped
    ports:
      - "9003:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-maxops}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-maxops_secure_password}
      POSTGRES_DB: openproject
      TZ: Asia/Seoul
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - maxops-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-maxops} -d openproject"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------
  # Redis 캐시 서버
  # ------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: maxops-redis
    restart: unless-stopped
    ports:
      - "9004:6379"
    environment:
      TZ: Asia/Seoul
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    networks:
      - maxops-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------
  # OpenProject (프로젝트/일정/Task/문서 관리)
  # 접속: http://<IP>:9001
  # 초기 계정: admin / admin
  # ------------------------------------------
  openproject:
    image: openproject/openproject:14
    container_name: maxops-openproject
    restart: unless-stopped
    ports:
      - "9001:80"
    environment:
      # 호스트 설정 - 모든 호스트 허용
      OPENPROJECT_HOST__NAME: 172.168.30.207:9001
      OPENPROJECT_SECRET_KEY_BASE: ${OPENPROJECT_SECRET:-your_secret_key_base_here_min_64_chars_required_change_this}
      OPENPROJECT_HTTPS: "false"

      # 호스트 검증 완전 비활성화
      RAILS_DEVELOPMENT_HOSTS: ".localhost,localhost,[::1],172.168.30.207,172.22.166.206"
      OPENPROJECT_SKIP__HOSTNAME__VALIDATION: "true"

      # PostgreSQL 설정
      DATABASE_URL: "postgres://${POSTGRES_USER:-maxops}:${POSTGRES_PASSWORD:-maxops_secure_password}@postgres:5432/openproject"

      # 한국어 기본 설정
      OPENPROJECT_DEFAULT__LANGUAGE: ko
      TZ: Asia/Seoul

      # 성능 설정
      OPENPROJECT_WEB_WORKERS: 2
      OPENPROJECT_WEB_TIMEOUT: 300
    volumes:
      - ./data/openproject/data:/var/openproject/pgdata
      - ./data/openproject/assets:/var/openproject/assets
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - maxops-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health_checks/default"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ------------------------------------------
  # Gitea (Git 저장소/CI-CD)
  # 접속: http://<IP>:9002
  # 초기 계정: 최초 접속시 생성
  # ------------------------------------------
  gitea:
    image: gitea/gitea:1.21-rootless
    container_name: maxops-gitea
    restart: unless-stopped
    ports:
      - "9002:3000"
      - "9022:22"
    environment:
      # 기본 설정
      GITEA__DEFAULT__APP_NAME: "MaxOps Git"
      GITEA__DEFAULT__RUN_USER: git
      GITEA__DEFAULT__RUN_MODE: prod

      # 서버 설정
      GITEA__server__DOMAIN: ${GITEA_DOMAIN:-172.168.30.207}
      GITEA__server__SSH_DOMAIN: ${GITEA_SSH_DOMAIN:-172.168.30.207}
      GITEA__server__HTTP_PORT: 3000
      GITEA__server__ROOT_URL: ${GITEA_ROOT_URL:-http://172.168.30.207:9002/}
      GITEA__server__SSH_PORT: 9022
      GITEA__server__SSH_LISTEN_PORT: 22
      GITEA__server__LFS_START_SERVER: "true"

      # 데이터베이스 설정
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: postgres:5432
      GITEA__database__NAME: gitea
      GITEA__database__USER: ${POSTGRES_USER:-maxops}
      GITEA__database__PASSWD: ${POSTGRES_PASSWORD:-maxops_secure_password}

      # 캐시 설정
      GITEA__cache__ENABLED: "true"
      GITEA__cache__ADAPTER: redis
      GITEA__cache__HOST: "redis://redis:6379/0"

      # 세션 설정
      GITEA__session__PROVIDER: redis
      GITEA__session__PROVIDER_CONFIG: "redis://redis:6379/1"

      # 한국어 설정
      GITEA__i18n__LANGS: "ko-KR,en-US"
      GITEA__i18n__NAMES: "한국어,English"

      # 타임존
      TZ: Asia/Seoul

      # 보안 설정
      GITEA__security__INSTALL_LOCK: "false"
      GITEA__security__SECRET_KEY: ${GITEA_SECRET_KEY:-your_gitea_secret_key_here}

      # Webhook 설정
      GITEA__webhook__ALLOWED_HOST_LIST: "*"
    volumes:
      - ./data/gitea/data:/var/lib/gitea
      - ./data/gitea/config:/etc/gitea
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - maxops-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
