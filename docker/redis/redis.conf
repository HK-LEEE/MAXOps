# ============================================
# MaxOps Redis 설정 파일
# ============================================

# ------------------------------------------
# 네트워크 설정
# ------------------------------------------
# 모든 인터페이스에서 연결 허용 (Docker 네트워크용)
bind 0.0.0.0

# 포트 설정
port 6379

# 보호 모드 비활성화 (Docker 내부 통신용)
protected-mode no

# TCP 백로그 설정
tcp-backlog 511

# 연결 타임아웃 (0: 비활성화)
timeout 0

# TCP Keepalive
tcp-keepalive 300

# ------------------------------------------
# 일반 설정
# ------------------------------------------
# 데몬 모드 비활성화 (Docker에서 foreground 실행)
daemonize no

# PID 파일
pidfile /var/run/redis/redis-server.pid

# 로그 레벨: debug, verbose, notice, warning
loglevel notice

# 로그 파일 (빈 문자열: stdout)
logfile ""

# 데이터베이스 개수
databases 16

# ------------------------------------------
# 스냅샷 (RDB 영속성)
# ------------------------------------------
# 900초(15분) 동안 1개 이상 키 변경 시 저장
save 900 1

# 300초(5분) 동안 10개 이상 키 변경 시 저장
save 300 10

# 60초 동안 10000개 이상 키 변경 시 저장
save 60 10000

# 백그라운드 저장 실패 시 쓰기 거부
stop-writes-on-bgsave-error yes

# RDB 파일 압축
rdbcompression yes

# RDB 체크섬
rdbchecksum yes

# RDB 파일명
dbfilename dump.rdb

# 작업 디렉토리
dir /data

# ------------------------------------------
# AOF 영속성 (Append Only File)
# ------------------------------------------
# AOF 활성화
appendonly yes

# AOF 파일명
appendfilename "appendonly.aof"

# AOF 동기화 정책: always, everysec, no
appendfsync everysec

# 재작성 중 fsync 비활성화
no-appendfsync-on-rewrite no

# AOF 재작성 트리거 (100% 증가 시)
auto-aof-rewrite-percentage 100

# AOF 최소 크기
auto-aof-rewrite-min-size 64mb

# ------------------------------------------
# 메모리 관리
# ------------------------------------------
# 최대 메모리 (512MB)
maxmemory 512mb

# 메모리 정책: volatile-lru, allkeys-lru, volatile-random, allkeys-random, volatile-ttl, noeviction
maxmemory-policy allkeys-lru

# LRU 샘플 수
maxmemory-samples 5

# ------------------------------------------
# 레플리케이션 설정
# ------------------------------------------
# 레플리카 읽기 전용
replica-read-only yes

# 복제 백로그 크기
repl-backlog-size 1mb

# ------------------------------------------
# 보안 설정
# ------------------------------------------
# 위험한 명령어 비활성화
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""

# ------------------------------------------
# 클라이언트 설정
# ------------------------------------------
# 최대 클라이언트 수
maxclients 10000

# ------------------------------------------
# 슬로우 로그
# ------------------------------------------
# 10ms 이상 걸리는 쿼리 기록
slowlog-log-slower-than 10000

# 슬로우 로그 최대 길이
slowlog-max-len 128

# ------------------------------------------
# 이벤트 알림
# ------------------------------------------
# 키 만료 이벤트 활성화
notify-keyspace-events Ex

# ------------------------------------------
# 고급 설정
# ------------------------------------------
# Hash 압축 임계값
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List 압축 임계값
list-max-ziplist-size -2

# Set 압축 임계값
set-max-intset-entries 512

# Sorted Set 압축 임계값
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog 임계값
hll-sparse-max-bytes 3000

# 스트림 설정
stream-node-max-bytes 4096
stream-node-max-entries 100

# 활성 재해싱
activerehashing yes

# 클라이언트 출력 버퍼 제한
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Hz 설정 (백그라운드 작업 빈도)
hz 10

# 동적 Hz
dynamic-hz yes

# AOF 재작성 증분 fsync
aof-rewrite-incremental-fsync yes

# RDB 증분 fsync
rdb-save-incremental-fsync yes
